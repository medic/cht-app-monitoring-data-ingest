replication_failure_reasons:
  query: |
    SELECT
      metric as failure_type,
      sum(count) AS count,
      failures.partner_name,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      app_monitoring_replication_failure_reasons as failures
    LEFT JOIN
      monitoring_urls ON failures.partner_name=monitoring_urls.partner_name
    GROUP BY
      failures.partner_name,
      failure_type,
      cht_instance
    ORDER BY
      partner_name, count DESC
  metrics:
    - failure_type:
        usage: "LABEL"
    - partner_name:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"
    - count:
        usage: "GAUGE"

users_past_replication_limit:
  query: |
    SELECT
      max("users past replication_limit") AS user_count,
      users.partner_name,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      public.app_monitoring_users_replication_limit as users
    LEFT JOIN
      monitoring_urls ON users.partner_name=monitoring_urls.partner_name
    GROUP BY
      users.partner_name,
      cht_instance
    ORDER BY
      users.partner_name
  metrics:
    - user_count:
        usage: "GAUGE"
    - partner_name:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"

users_with_insufficient_disk:
  query: |
    SELECT
      user_name AS user_name,
      free_storage_mb AS free_storage_mb,
      disk.partner_name,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      public.app_monitoring_users_with_insufficient_disk as disk
    LEFT JOIN
      monitoring_urls ON disk.partner_name=monitoring_urls.partner_name
    GROUP BY
      disk.partner_name,
      cht_instance,
      user_name,
      free_storage_mb
    ORDER BY
      free_storage_mb ASC
  metrics:
    - free_storage_mb:
        usage: "GAUGE"
    - user_name:
        usage: "LABEL"
    - partner_name:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"

users_with_insufficient_chrome_version:
  query: |
    SELECT
      partner_name,
      user_name,
      chrome_version,
      required_chrome_version,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      public.app_monitoring_users_with_insufficient_chrome AS chrome
    LEFT JOIN
      monitoring_urls ON chrome.partner_name=monitoring_urls.partner_name
  metrics:
    - partner_name:
        usage: "LABEL"
    - user_name:
        usage: "LABEL"
    - chrome_version:
        usage: "GAUGE"
    - required_chrome_version:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"

feedback_docs:
  query: |
    SELECT
        feedback.partner_name,
        source,
        count(*) AS source_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_feedback_docs AS feedback
    LEFT JOIN
        monitoring_urls ON feedback.partner_name=monitoring_urls.partner_name
    GROUP BY
        feedback.partner_name,
        source,
        cht_instance
  metrics:
    - partner_name:
        usage: "LABEL"
    - source:
        usage: "LABEL"
    - source_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

manual_feedback_docs:
  query: |
    SELECT
        feedback.partner_name,
        reported::varchar(255),
        detail,
        count(*) AS detail_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_feedback_docs AS feedback
    LEFT JOIN
        monitoring_urls ON feedback.partner_name=monitoring_urls.partner_name
    WHERE source = 'manual'
    GROUP BY
        feedback.partner_name,
        reported,
        source,
        detail,
        cht_instance
  metrics:
    - partner_name:
        usage: "LABEL"
    - reported:
        usage: "LABEL"
    - detail:
        usage: "LABEL"
    - detail_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

automatic_feedback_docs:
  query: |
    SELECT
        feedback.partner_name,
        reported::varchar(255),
        detail,
        count(*) AS detail_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_feedback_docs AS feedback
    LEFT JOIN
        monitoring_urls ON feedback.partner_name=monitoring_urls.partner_name
    WHERE source = 'automatic'
    GROUP BY
        feedback.partner_name,
        reported,
        source,
        detail,
        cht_instance
  metrics:
    - partner_name:
        usage: "LABEL"
    - reported:
        usage: "LABEL"
    - detail:
        usage: "LABEL"
    - detail_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

replication_by_status:
  query: |
    SELECT
        status.partner_name,
        period_start::varchar(255),
        replication_success_count,
        replication_failure_count,
        replication_denied_count,
        replication_error_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_replication_by_status AS status
    LEFT JOIN
        monitoring_urls ON status.partner_name=monitoring_urls.partner_name
  metrics:
    - partner_name:
        usage: "LABEL"
    - period_start:
        usage: "LABEL"
    - replication_success_count:
        usage: "GAUGE"
    - replication_failure_count:
        usage: "GAUGE"
    - replication_denied_count:
        usage: "GAUGE"
    - replication_error_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

sms_error_and_users_docs_replication:
  query: |
    SELECT
        sms.partner_name,
        reported::varchar(255),
        due,
        muted,
        failed,
        delivered,
        scheduled,
        delta_docs,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_sms_error_and_users_docs_replication AS sms
    LEFT JOIN
        monitoring_urls ON sms.partner_name=monitoring_urls.partner_name
  metrics:
    - partner_name:
        usage: "LABEL"
    - reported:
        usage: "LABEL"
    - due:
        usage: "GAUGE"
    - muted:
        usage: "GAUGE"
    - failed:
        usage: "GAUGE"
    - delivered:
        usage: "GAUGE"
    - scheduled:
        usage: "GAUGE"
    - delta_docs:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

initial_replications:
  query: |
    SELECT
        initial.partner_name,
        date::varchar(255),
        count_initial_replications,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_initial_replications AS initial
    LEFT JOIN
        monitoring_urls ON initial.partner_name=monitoring_urls.partner_name
  metrics:
    - partner_name:
        usage: "LABEL"
    - date:
        usage: "LABEL"
    - count_initial_replications:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

chw_engagement:
  query: |
    SELECT
        chw.partner_name,
        last_sync::varchar(255),
        days_since_last_sync,
        chw_username,
        chw_id,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_chw_engagement AS chw
    LEFT JOIN
        monitoring_urls ON chw.partner_name=monitoring_urls.partner_name
  metrics:
    - partner_name:
        usage: "LABEL"
    - last_sync:
        usage: "LABEL"
    - days_since_last_sync:
        usage: "GAUGE"
    - chw_username:
        usage: "LABEL"
    - chw_id:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"