replication_failure_reasons:
  query: |
    SELECT
      metric as failure_type,
      sum(count) AS count,
      failures.partner_name,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      app_monitoring_replication_failure_reasons as failures
    LEFT JOIN
      monitoring_urls ON failures.partner_name=monitoring_urls.partner_name
    GROUP BY
      failures.partner_name,
      failure_type,
      cht_instance
    ORDER BY
      partner_name, count DESC
  metrics:
    - failure_type:
        usage: "LABEL"
    - partner_name:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"
    - count:
        usage: "GAUGE"

users_past_replication_limit:
  query: |
    SELECT
      max("users past replication_limit") AS user_count,
      users.partner_name,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      public.app_monitoring_users_replication_limit as users
    LEFT JOIN
      monitoring_urls ON users.partner_name=monitoring_urls.partner_name
    GROUP BY
      users.partner_name,
      cht_instance
    ORDER BY
      users.partner_name
  metrics:
    - user_count:
        usage: "GAUGE"
    - partner_name:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"

users_with_insufficient_disk:
  query: |
    SELECT
      user_name AS user_name,
      free_storage_mb AS free_storage_mb,
      disk.partner_name,
      replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM
      public.app_monitoring_users_with_insufficient_disk as disk
    LEFT JOIN
      monitoring_urls ON disk.partner_name=monitoring_urls.partner_name
    GROUP BY
      disk.partner_name,
      cht_instance,
      user_name,
      free_storage_mb
    ORDER BY
      free_storage_mb ASC
  metrics:
    - free_storage_mb:
        usage: "GAUGE"
    - user_name:
        usage: "LABEL"
    - partner_name:
        usage: "LABEL"
    - cht_instance:
        usage: "LABEL"

feedback_docs:
  query: |
    SELECT
        feedback.partner_name,
        source,
        count(*) AS source_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_feedback_docs AS feedback
    LEFT JOIN
        monitoring_urls ON feedback.partner_name=monitoring_urls.partner_name
    GROUP BY
        feedback.partner_name,
        source,
        cht_instance
  metrics:
    - partner_name:
        usage: "LABEL"
    - source:
        usage: "LABEL"
    - source_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"

manual_feedback_docs:
  query: |
    SELECT
        feedback.partner_name,
        reported::varchar(255),
        detail,
        count(*) AS detail_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_feedback_docs AS feedback
    LEFT JOIN
        monitoring_urls ON feedback.partner_name=monitoring_urls.partner_name
    WHERE source = 'manual'
    GROUP BY
        feedback.partner_name,
        reported,
        source,
        detail,
        cht_instance
  metrics:
    - partner_name:
        usage: "LABEL"
    - reported:
        usage: "LABEL"
    - detail:
        usage: "LABEL"
    - detail_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"


automatic_feedback_docs:
  query: |
    SELECT
        feedback.partner_name,
        reported::varchar(255),
        detail,
        count(*) AS detail_count,
        replace(monitoring_urls.url, 'https://', '') as cht_instance
    FROM app_monitoring_feedback_docs AS feedback
    LEFT JOIN
        monitoring_urls ON feedback.partner_name=monitoring_urls.partner_name
    WHERE source = 'automatic'
    GROUP BY
        feedback.partner_name,
        reported,
        source,
        detail,
        cht_instance
  metrics:
    - partner_name:
        usage: "LABEL"
    - reported:
        usage: "LABEL"
    - detail:
        usage: "LABEL"
    - detail_count:
        usage: "GAUGE"
    - cht_instance:
        usage: "LABEL"